generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password_hash String
  name          String
  phone         String?
  role          Role     @default(CUSTOMER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ownedShops    Shop[]        @relation("ShopOwner")
  appointments  Appointment[] // As customer
  staffProfiles StaffProfile[]
  subscription  Subscription?
}

model Subscription {
  id                   Int      @id @default(autoincrement())
  userId               Int      @unique
  user                 User     @relation(fields: [userId], references: [id])
  stripeSubscriptionId String   @unique
  status               String   // active, past_due, canceled, etc.
  currentPeriodEnd     DateTime
  planId               String
  last_reset_date      DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  benefits             SubscriptionBenefit[]
}

model SubscriptionBenefit {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  serviceType    String       // e.g., "HAIRCUT", "BEARD"
  remaining      Int          // Current balance
  resetAmount    Int          // Amount to reset to monthly
  updatedAt      DateTime     @updatedAt
}

model Shop {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  ownerId     Int
  owner       User     @relation("ShopOwner", fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  services    Service[]
  staff       StaffProfile[]
  appointments Appointment[]
}

model StaffProfile {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  shopId      Int
  shop        Shop     @relation(fields: [shopId], references: [id])
  
  // Relations
  schedules   Schedule[]
  appointments Appointment[] // As barber
  deletedAt   DateTime?
}

enum ServiceType {
  HAIRCUT
  BEARD
  OTHER
}

model GlobalService {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  imageUrl    String?
  type        ServiceType @default(OTHER)
  defaultDuration Int      // in minutes
  defaultPrice    Decimal
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services    Service[]
}

model Service {
  id          Int      @id @default(autoincrement())
  shopId      Int
  shop        Shop     @relation(fields: [shopId], references: [id])
  globalServiceId Int?
  globalService GlobalService? @relation(fields: [globalServiceId], references: [id])
  name        String
  description String?
  imageUrl    String?
  type        ServiceType @default(OTHER)
  duration    Int      // in minutes
  bufferTime  Int      @default(0) // in minutes
  price       Decimal
  
  appointments Appointment[]
}

model Appointment {
  id          Int               @id @default(autoincrement())
  shopId      Int
  shop        Shop              @relation(fields: [shopId], references: [id])
  customerId  Int
  customer    User              @relation(fields: [customerId], references: [id])
  barberId    Int
  barber      StaffProfile      @relation(fields: [barberId], references: [id])
  serviceId   Int
  service     Service           @relation(fields: [serviceId], references: [id])
  startTime   DateTime
  status      AppointmentStatus @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  paymentMethod PaymentMethod?
  stripeSessionId String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum PaymentMethod {
  STRIPE
  CASH
  SUBSCRIPTION
}

model Schedule {
  id          Int          @id @default(autoincrement())
  barberId    Int
  barber      StaffProfile @relation(fields: [barberId], references: [id])
  dayOfWeek   Int          // 0-6 (Sun-Sat)
  startTime   String       // "09:00"
  endTime     String       // "17:00"
  isAvailable Boolean      @default(true)
  breaks      Break[]
}

model Break {
  id          Int      @id @default(autoincrement())
  scheduleId  Int
  schedule    Schedule @relation(fields: [scheduleId], references: [id])
  startTime   String   // "12:00"
  endTime     String   // "13:00"
}
